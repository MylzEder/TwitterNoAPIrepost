const puppeteer = require('puppeteer');
const fs = require('fs');

async function downloadTwitterPost(url) {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  
  // Emulate mobile device for a better experience
  const mobile = puppeteer.devices['iPhone X'];
  await page.emulate(mobile);
  
  await page.goto(url);
  
  // Wait for the post image to load
  await page.waitForSelector('article div[role="presentation"] img[src^="https://pbs.twimg.com/media/"]');
  
  // Get the source URL of the post image
  const imageURL = await page.evaluate(() => {
    const imageElement = document.querySelector('article div[role="presentation"] img[src^="https://pbs.twimg.com/media/"]');
    return imageElement ? imageElement.src : null;
  });
  
  if (imageURL) {
    // Download the image
    const buffer = await page.evaluate(async (url) => {
      const response = await fetch(url);
      return await response.arrayBuffer();
    }, imageURL);
    
    // Save the image to a file
    fs.writeFileSync('twitter_post_image.jpg', Buffer.from(buffer));
    console.log('Image downloaded successfully!');
  } else {
    console.log('Unable to find the post image.');
  }
  
  await browser.close();
}

// Usage: Provide the URL of the tweet as a command-line argument
const tweetURL = process.argv[2];
if (tweetURL) {
  downloadTwitterPost(tweetURL);
} else {
  console.log('Please provide the URL of the tweet.');
}